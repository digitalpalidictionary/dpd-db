name: Test Apple Dictionary Build

# Test workflow to verify Apple Dictionary can be built in CI
# Strategy: Linux generates source files, macOS compiles with DDK + Rosetta 2

on: 
 workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Generate Dictionary Source on Linux
  # ============================================
  generate-source:
    runs-on: ubuntu-latest

    steps:
      - name: Create Dummy Dictionary Source
        run: |
          mkdir -p apple-dict-source
          
          # Create minimal Dictionary.xml with proper namespaces
          cat > apple-dict-source/Dictionary.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <d:dictionary xmlns="http://www.w3.org/1999/xhtml" xmlns:d="http://www.apple.com/DTDs/DictionaryService-1.0.rng">
          <d:entry id="test_1" d:title="ākāsa">
              <d:index d:value="ākāsa"/>
              <d:index d:value="akasa"/>
              <h1>ākāsa</h1>
              <div class="content">
                  <p><strong>masc.</strong> space, sky; open air; ether</p>
                  <p class="example">ākāsena gacchati — he goes through the sky</p>
              </div>
          </d:entry>
          <d:entry id="test_2" d:title="buddha">
              <d:index d:value="buddha"/>
              <d:index d:value="buddho"/>
              <h1>buddha</h1>
              <div class="content">
                  <p><strong>masc.</strong> the awakened one; the Buddha</p>
                  <p class="example">buddhaṃ saraṇaṃ gacchāmi — I go for refuge to the Buddha</p>
              </div>
          </d:entry>
          <d:entry id="test_3" d:title="dhamma">
              <d:index d:value="dhamma"/>
              <d:index d:value="dhammo"/>
              <d:index d:value="dhammaṃ"/>
              <h1>dhamma</h1>
              <div class="content">
                  <p><strong>masc.</strong> teaching; truth; phenomenon; nature; law</p>
                  <p class="example">dhammaṃ saraṇaṃ gacchāmi — I go for refuge to the Dhamma</p>
              </div>
          </d:entry>
          </d:dictionary>
          EOF
          
          # Create CSS with DPD styling
          cat > apple-dict-source/Dictionary.css << 'EOF'
          /* Digital Pali Dictionary - Apple Dictionary Stylesheet */
          @charset "UTF-8";
          
          h1 {
              color: #0099cc;
              font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
              font-size: 1.5em;
              margin-bottom: 0.5em;
          }
          
          .content {
              font-size: 14px;
              line-height: 1.5;
              font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          }
          
          .content p {
              margin: 0.3em 0;
          }
          
          .example {
              color: #666;
              font-style: italic;
              margin-left: 1em;
          }
          
          strong {
              color: #0077aa;
          }
          EOF
          
          # Create Info.plist with DPD metadata
          cat > apple-dict-source/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>English</string>
              <key>CFBundleDisplayName</key>
              <string>Digital Pali Dictionary (Test)</string>
              <key>CFBundleIdentifier</key>
              <string>org.digitalpalidictionary.dpd.test</string>
              <key>CFBundleName</key>
              <string>DPD-Test</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>DCSDictionaryCopyright</key>
              <string>Copyright © Digital Pali Dictionary. CC BY-NC 4.0</string>
              <key>DCSDictionaryManufacturerName</key>
              <string>Digital Pali Dictionary</string>
              <key>DCSDictionaryFrontMatterReferenceID</key>
              <string>front_back_matter</string>
              <key>DCSDictionaryPrefsHTML</key>
              <string>DPD_prefs.html</string>
          </dict>
          </plist>
          EOF
          
          echo "✓ Dictionary source files created on Linux"
          ls -la apple-dict-source/
          echo ""
          echo "=== Dictionary.xml preview ==="
          head -20 apple-dict-source/Dictionary.xml

      - name: Upload Dictionary Source
        uses: actions/upload-artifact@v4
        with:
          name: apple-dictionary-source
          path: apple-dict-source/
          retention-days: 1

  # ============================================
  # Job 2: Compile Dictionary on macOS
  # ============================================
  compile-dictionary:
    needs: generate-source
    runs-on: macos-14

    steps:
      - name: Download Dictionary Source
        uses: actions/download-artifact@v4
        with:
          name: apple-dictionary-source
          path: ./source/

      - name: Verify Source Files
        run: |
          echo "=== Downloaded source files ==="
          ls -la ./source/
          echo ""
          echo "=== XML validation ==="
          head -30 ./source/Dictionary.xml

      # CRITICAL: Install Rosetta 2 for Intel binary compatibility
      - name: Install Rosetta 2
        run: |
          echo "=== Installing Rosetta 2 for Intel binary support ==="
          softwareupdate --install-rosetta --agree-to-license || true
          echo "✓ Rosetta 2 ready"

      - name: Setup Dictionary Development Kit
        run: |
          set -x
          
          # Clone the DDK
          git clone --depth 1 https://github.com/SebastianSzturo/Dictionary-Development-Kit.git
          
          DDK_PATH="$(pwd)/Dictionary-Development-Kit"
          
          # Patch all scripts and makefiles to use local path instead of /DevTools
          # The DDK has hardcoded paths that we need to replace
          echo "=== Patching DDK to use local path ==="
          
          # Patch the build_dict script (it's a shell script that calls other binaries)
          if [ -f "$DDK_PATH/bin/build_dict" ]; then
            # Replace hardcoded /DevTools path with our local path
            sed -i.bak "s|/DevTools/Utilities/Dictionary Development Kit|$DDK_PATH|g" "$DDK_PATH/bin/build_dict" 2>/dev/null || \
            sed -i '' "s|/DevTools/Utilities/Dictionary Development Kit|$DDK_PATH|g" "$DDK_PATH/bin/build_dict"
            
            chmod +x "$DDK_PATH/bin/build_dict"
            chmod +x "$DDK_PATH/bin/binarize" 2>/dev/null || true
            chmod +x "$DDK_PATH/bin/xml2dict" 2>/dev/null || true
            
            echo "✓ DDK patched and ready"
            echo "=== build_dict script content ==="
            head -30 "$DDK_PATH/bin/build_dict"
          else
            echo "✗ ERROR: build_dict not found"
            find . -name "build_dict" 2>/dev/null
            exit 1
          fi
          
          # Export path for next step
          echo "DDK_PATH=$DDK_PATH" >> $GITHUB_ENV

      - name: Build Dictionary
        run: |
          set -x
          
          # Prepare build directory
          mkdir -p build
          cp ./source/Dictionary.xml ./build/
          cp ./source/Dictionary.css ./build/
          cp ./source/Info.plist ./build/
          
          cd build
          
          echo "=== Source files in build directory ==="
          ls -la
          
          echo "=== Starting dictionary compilation with Rosetta 2 ==="
          # Use arch -x86_64 to run Intel binaries via Rosetta 2
          arch -x86_64 "/DevTools/Utilities/Dictionary Development Kit/bin/build_dict" \
            "DPD-Test" \
            Dictionary.xml \
            Dictionary.css \
            Info.plist 2>&1 | tee build_log.txt || {
              echo "=== Build log ==="
              cat build_log.txt
              echo "=== Checking for partial output ==="
              ls -la
            }
          
          # Verify output
          if [ -d "DPD-Test.dictionary" ]; then
            echo "✓ SUCCESS: Dictionary bundle created!"
            ls -la "DPD-Test.dictionary"
            du -sh "DPD-Test.dictionary"
          else
            echo "✗ ERROR: Dictionary bundle not created"
            echo "=== Build log ==="
            cat build_log.txt
            exit 1
          fi

      - name: Package Dictionary
        run: |
          cd build
          zip -r DPD-Test.dictionary.zip DPD-Test.dictionary
          echo "=== Packaged dictionary ==="
          ls -lh *.zip

      - name: Upload Dictionary
        uses: actions/upload-artifact@v4
        with:
          name: dpd-test-dictionary
          path: build/DPD-Test.dictionary.zip
          retention-days: 7
