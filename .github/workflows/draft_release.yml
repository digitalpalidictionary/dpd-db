name: Draft Release

on: 
 workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      RELEASE_DATE: ${{ steps.set_release_date.outputs.RELEASE_DATE }}
      RELEASE_TAG: ${{ steps.set_release_tag.outputs.RELEASE_TAG }}

    steps:

    # ----------------------------------------
    # Setup
    # ----------------------------------------

    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        repository: 'digitalpalidictionary/dpd-db'
        ref: 'main'
        submodules: 'recursive'
        # Fetch depth 1 for shallow clone to save disk space
        fetch-depth: 1
        # Use PAT to allow pushing to the submodule
        token: ${{ secrets.GH_PAT }}

    - name: Remove large dirs
      run: |
        rm -rf ${{ github.workspace }}/resources/bjt/dev/*
        rm -rf ${{ github.workspace }}/resources/sc-data/html_text/*

    - name: Unzip deconstructor_output
      run: |
        cd ${{ github.workspace }}/resources/deconstructor_output
        tar -xzvf deconstructor_output.json.tar.gz
        ls -la
        cd ${{ github.workspace }}/
    
    - name: Install dictzip
      run: sudo apt-get update && sudo apt-get install -y dictzip

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"

    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh
    
    - name: Install dependencies
      run: uv sync --all-groups

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22.2'

    # ----------------------------------------
    # Build Database
    # ----------------------------------------

    - name: Config for GitHub release
      run: uv run python scripts/build/config_github_release.py

    - name: Create dpd.db
      run: touch dpd.db

    - name: Build the database
      run: uv run python scripts/build/db_rebuild_from_tsv.py

    - name: Run initial setup script
      run: uv run python scripts/bash/initial_setup_run_once.py
    
    - name: Create version
      run: uv run python tools/version.py

    - name: Create Inflection Templates
      run: uv run python db/inflections/create_inflection_templates.py

    - name: Create Inflection Tables
      run: uv run python db/inflections/generate_inflection_tables.py

    - name: Update Root Has Verb values
      run: uv run python scripts/build/root_has_verb_updater.py

    - name: Update Sanskrit Family Roots
      run: uv run python scripts/build/sanskrit_root_families_updater.py

    - name: Add Root Families
      run: uv run python db/families/family_root.py

    - name: Add Word Families
      run: uv run python db/families/family_word.py
    
    - name: Add Compound Families
      run: uv run python db/families/family_compound.py

    - name: Add Sets
      run: uv run python db/families/family_set.py

    - name: Add Idioms
      run: uv run python db/families/family_idiom.py

    - name: Families to JSON
      run: uv run python scripts/build/families_to_json.py

    - name: Extract Variants
      run: uv run python db/variants/main.py

    - name: Run Deconstructor
      run: uv run python scripts/build/deconstructor_output_add_to_db.py
        
    - name: Add api ca eva iti to inflections 
      run: uv run python scripts/build/api_ca_eva_iti_iva_hi.py

    - name: Transliterate Inflections
      run: uv run python db/inflections/transliterate_inflections.py

    - name: Inflections to Headwords
      run: uv run python db/inflections/inflections_to_headwords.py

    - name: Populate Sutta table
      run: uv run python db/suttas/suttas_update.py

    - name: Add Suttas to Lookup table
      run: uv run python db/suttas/suttas_to_lookup.py

    - name: Generate Grammar data
      run: uv run python db/grammar/grammar_to_lookup.py

    - name: Lookup Variants and Spelling Mistakes 
      run: uv run python db/lookup/spelling_mistakes.py

    - name: Lookup Transliterate
      run: uv run python db/lookup/transliterate_lookup_table.py

    - name: Lookup Help and Abbreviations
      run: uv run python db/lookup/help_abbrev_add_to_lookup.py

    - name: Add Frequency
      run: |
        go build -o frequency go_modules/frequency/main.go
        ./frequency

    - name: Run EBT Counter
      run: uv run python scripts/build/ebt_counter.py

    - name: Add EPD to Lookup Table
      run: uv run python db/epd/epd_to_lookup.py
      
    - name: Test Dealbreakers
      run: uv run python scripts/build/dealbreakers.py

    # ----------------------------------------
    # Download Audio Database
    # ----------------------------------------

    - name: Download Audio Database
      run: uv run python audio/db_release_download.py

    # ----------------------------------------
    # Exporter
    # ----------------------------------------

    - name: Setup disk space checker
      run: |
        cat << 'EOF' >> $HOME/check_disk.sh
        #!/bin/bash
        echo "=== Disk space and large files (>1GB) ==="
        df -h
        du -h --max-depth=2 ${{ github.workspace }} | grep -E "^[0-9.]+[GT]" || echo "No files >1GB found"
        EOF
        chmod +x $HOME/check_disk.sh
           
    - name: Export Grammar Dictionary
      run: uv run python exporter/grammar_dict/grammar_dict.py
    
    - name: Export GoldenDict & MDict
      run: |
        uv run python exporter/goldendict/main.py
        echo "=== After GoldenDict export ==="
        $HOME/check_disk.sh

    - name: Delete Audio Database to free space
      run: |
        echo "=== Before deleting audio DB ==="
        $HOME/check_disk.sh
        rm -rf ${{ github.workspace }}/audio/db/dpd_audio.db
        echo "=== After deleting audio DB ==="
        $HOME/check_disk.sh

    - name: Export Deconstructor
      run: |
        uv run python exporter/deconstructor/deconstructor_exporter.py
        echo "=== After Deconstructor export ==="
        $HOME/check_disk.sh

    - name: Export Kindle & ePub
      run: |
        uv run python exporter/kindle/kindle_exporter.py
        echo "=== After Kindle export ==="
        $HOME/check_disk.sh

    - name: Export Kobo
      run: |
        uv run python exporter/kobo/kobo.py
        echo "=== After Kobo export ==="
        $HOME/check_disk.sh

    - name: Export Variants
      run: |
        uv run python exporter/variants/variants_exporter.py
        echo "=== After Variants export ==="
        $HOME/check_disk.sh

    - name: Export TXT
      run: |
        uv run python exporter/txt/export_txt.py
        echo "=== After TXT export ==="
        $HOME/check_disk.sh

    # ----------------------------------------
    # Export Apple Dictionary Source
    # ----------------------------------------

    - name: Export Apple Dictionary
      run: |
        uv run python exporter/apple_dictionary/apple_dictionary.py
        echo "=== After Apple Dictionary export ==="
        ls -lh exporter/share/apple_dictionary/
        $HOME/check_disk.sh

    # ----------------------------------------
    # Package Assets
    # ----------------------------------------

    - name: Zip GoldenDict & Mdict
      run: |
        uv run python scripts/build/zip_goldendict_mdict.py
        echo "=== After zipping ==="
        $HOME/check_disk.sh

    - name: Tarball DB
      run: |
        uv run python scripts/build/tarball_db.py
        echo "=== After tarball ==="
        $HOME/check_disk.sh

    # ----------------------------------------
    # Upload Artifacts for macOS Build
    # ----------------------------------------

    - name: Upload Apple Dictionary Source
      uses: actions/upload-artifact@v4
      with:
        name: apple-dictionary-source
        path: exporter/share/apple_dictionary/
        retention-days: 1

    # ----------------------------------------
    # Prepare Release Metadata
    # ----------------------------------------

    - name: Make Release Notes
      run: uv run python tools/docs_changelog_and_release_notes.py

    - name: Set Release Date
      id: set_release_date
      run: |
        echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        echo "RELEASE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Set Release Tag
      id: set_release_tag
      run: |
        echo "RELEASE_TAG=$(uv run python scripts/build/version_print.py)" >> $GITHUB_ENV
        echo "RELEASE_TAG=$(uv run python scripts/build/version_print.py)" >> $GITHUB_OUTPUT

    - name: Prepare Kobo Asset
      run: cp exporter/share/dicthtml-pi-en.zip exporter/share/dpd-kobo.zip

    # ----------------------------------------
    # Upload Linux Artifacts
    # ----------------------------------------

    - name: Upload Linux Assets
      uses: actions/upload-artifact@v4
      with:
        name: linux-assets
        path: |
          exporter/share/dpd-goldendict.zip
          exporter/share/dpd-mdict.zip
          exporter/share/dpd-kindle.epub
          exporter/share/dpd-kindle.mobi
          exporter/share/dpd.db.tar.bz2
          exporter/share/dpd-kobo.zip
          exporter/share/dpd-txt.zip
          exporter/share/release_notes.md
        retention-days: 1

  # ----------------------------------------
  # Job 2: Build macOS Dictionary
  # ----------------------------------------

  build-macos:
    needs: build-linux
    # Use macOS 14 (ARM64) runner
    runs-on: macos-14

    steps:
      - name: Download Apple Dictionary Source
        uses: actions/download-artifact@v4
        with:
          name: apple-dictionary-source
          path: ./apple-dictionary-source/

      - name: Setup Dictionary Development Kit
        run: |
          set -x
          
          # Explicitly install Rosetta 2 for safety (though often pre-installed)
          if /usr/bin/pgrep oahd >/dev/null 2>&1; then
              echo "Rosetta 2 is already running."
          else
              sudo softwareupdate --install-rosetta --agree-to-license
          fi
          
          # Clone the DDK
          git clone --depth 1 https://github.com/SebastianSzturo/Dictionary-Development-Kit.git
          
          # Export DDK path for all subsequent steps
          DDK_PATH="$(pwd)/Dictionary-Development-Kit"
          echo "DDK_PATH=$DDK_PATH" >> $GITHUB_ENV
          
          DDK_BIN="$DDK_PATH/bin/build_dict.sh"
          
          # Verify the tool exists
          if [ -f "$DDK_BIN" ]; then
            echo "✓ build_dict.sh found"
            chmod +x "$DDK_BIN"
            # Ensure all sub-binaries are executable
            chmod +x "$DDK_PATH/bin/"*
          else
            echo "✗ ERROR: build_dict.sh not found at $DDK_BIN"
            ls -R "$DDK_PATH"
            exit 1
          fi

      - name: Build Dictionary
        run: |
          set -x
          
          # Validation: Ensure source files exist and are not empty
          if [ ! -s "./apple-dictionary-source/Dictionary.xml" ]; then
            echo "✗ ERROR: Dictionary.xml is missing or empty!"
            ls -la ./apple-dictionary-source/
            exit 1
          fi
          
          # Prepare project directory
          mkdir -p build
          cp ./apple-dictionary-source/Dictionary.xml ./build/
          cp ./apple-dictionary-source/Dictionary.css ./build/
          cp ./apple-dictionary-source/Info.plist ./build/
          
          echo "=== Starting dictionary build ==="
          cd build
          
          # Call the shell script directly with Rosetta 2 (arch -x86_64)
          # It automatically finds its own helper binaries (like make_dict_package).
          arch -x86_64 "$DDK_PATH/bin/build_dict.sh" \
            "Digital-Pali-Dictionary" \
            Dictionary.xml \
            Dictionary.css \
            Info.plist 2>&1 | tee build_log.txt
            
          # The build script places the output in an 'objects' subdirectory
          if [ -d "objects/Digital-Pali-Dictionary.dictionary" ]; then
            echo "✓ Build successful, moving dictionary to root"
            mv objects/Digital-Pali-Dictionary.dictionary .
          else
            echo "✗ ERROR: Build failed to produce .dictionary bundle"
            cat build_log.txt
            exit 1
          fi
          
          echo "=== Build complete ==="
          ls -la

      - name: Package Dictionary
        run: |
          cd build
          # The dictionary is a bundle (folder). We zip it for distribution.
          zip -r Digital-Pali-Dictionary.dictionary.zip Digital-Pali-Dictionary.dictionary
          echo "=== Dictionary packaged ==="
          ls -lh *.zip

      - name: Upload macOS Dictionary
        uses: actions/upload-artifact@v4
        with:
          name: macos-dictionary
          path: build/Digital-Pali-Dictionary.dictionary.zip
          retention-days: 1

  # ----------------------------------------
  # Job 3: Create Draft Release
  # ----------------------------------------

  create-release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest

    steps:
      - name: Download Linux Assets
        uses: actions/download-artifact@v4
        with:
          name: linux-assets
          path: ./linux-assets/

      - name: Download macOS Dictionary
        uses: actions/download-artifact@v4
        with:
          name: macos-dictionary
          path: ./macos-dictionary/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-linux.outputs.RELEASE_TAG }}
          name: ${{ needs.build-linux.outputs.RELEASE_DATE }}
          body_path: ./linux-assets/release_notes.md
          draft: true
          prerelease: false
          files: |
            ./linux-assets/dpd-goldendict.zip
            ./linux-assets/dpd-mdict.zip
            ./linux-assets/dpd-kindle.epub
            ./linux-assets/dpd-kindle.mobi
            ./linux-assets/dpd.db.tar.bz2
            ./linux-assets/dpd-kobo.zip
            ./linux-assets/dpd-txt.zip
            ./macos-dictionary/Digital-Pali-Dictionary.dictionary.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}